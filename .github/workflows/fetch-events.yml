name: Fetch & Clean Live Events (Nobar)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

# Cegah tabrakan job lama
concurrency:
  group: nobar-events
  cancel-in-progress: true

jobs:
  fetch-events:
    runs-on: ubuntu-latest

    steps:
      # ===============================
      # 1. Checkout repo
      # ===============================
      - name: Checkout repo
        uses: actions/checkout@v4

      # ===============================
      # 2. Fetch API raw (page 1 & 2)
      # ===============================
      - name: Fetch API raw (page 1 & 2)
        run: |
          mkdir -p events

          echo "[INFO] Fetch page 1"
          curl -L --fail \
            "https://api.codetabs.com/v1/proxy/?quest=https://nobar.website/api/matches?filter=semua&page=1" \
            -o events/raw-page1.json

          echo "[INFO] Fetch page 2"
          curl -L --fail \
            "https://api.codetabs.com/v1/proxy/?quest=https://nobar.website/api/matches?filter=semua&page=2" \
            -o events/raw-page2.json

          # Validasi file tidak kosong
          [ -s events/raw-page1.json ] || exit 1
          [ -s events/raw-page2.json ] || exit 1

      # ===============================
      # 3. Merge raw pages (ANTI DATA LOSS)
      # ===============================
      - name: Merge raw pages safely
        run: |
          node - <<'EOF'
          const fs = require("fs");

          const p1 = JSON.parse(fs.readFileSync("events/raw-page1.json", "utf8"));
          const p2 = JSON.parse(fs.readFileSync("events/raw-page2.json", "utf8"));

          const mergedMatches = {};

          const mergePage = (page) => {
            for (const [league, matches] of Object.entries(page.matches || {})) {
              if (!mergedMatches[league]) mergedMatches[league] = [];
              mergedMatches[league].push(...matches);
            }
          };

          mergePage(p1);
          mergePage(p2);

          const merged = {
            ...p1,
            matches: mergedMatches
          };

          fs.writeFileSync(
            "events/raw.json",
            JSON.stringify(merged, null, 2)
          );

          console.log("[OK] Raw pages merged safely");
          EOF

      # ===============================
      # 4. Transform raw → clean (OTT SAFE)
      # ===============================
      - name: Transform raw → clean
        run: |
          node scripts/transform-events.js

      # ===============================
      # 5. Auto trigger ≤15 menit sebelum LIVE
      # ===============================
      - name: Auto trigger 15 minutes before LIVE
        run: |
          node scripts/auto-trigger-15m.js
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      # ===============================
      # 6. Commit results (AMAN)
      # ===============================
      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add events/raw.json events/clean.json
          git add events/raw-page1.json events/raw-page2.json

          if [ -f events/triggered.json ]; then
            git add events/triggered.json
          fi

          git commit -m "Update events ($(date +'%Y-%m-%d %H:%M'))" || echo "No changes"
          git push
